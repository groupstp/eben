{
  "name": "stages",
  "description": "Этапы",
  "common": "scheme",
  "fields": {
    "description": {
      "type": "string",
      "title": "Название"
    },
    "commentary": {
      "type": "string",
      "title": "Комментарий к заявке"
    },
    "queryID": {
      "type": "link",
      "link": "query",
      "title": "Заявка"
    },
    "expenditureID":{
      "type": "link",
      "link": "expenditure",
      "title": "Статья расходов"
    },
    "comment": {
      "type": "string",
      "title": "Комментарий"
    }
  },
  "uniqueFields":[
    "queryID"
  ],
  "stages": {
    "stages_financeControl": {
      "unique": {
        "queryID": "queryID"
      },
      "auto": true
    },
    "stages_directorControl": {
      "unique": {
        "queryID": "queryID"
      }
    },
    "stages_controlCompanyControl": {
      "unique": {
        "queryID": "queryID"
      },
      "toNextUpdate": [
        {
          "object": "query",
          "comments" : [
            "filterFields - поля для формирования фильтра, valuesFields - определяемые значения",
            "Фильтр формируется по принципу объединения условий через AND",
            "Каждое условие - сравнение поля filterFields[i].object у объекта object со значением поля filterFields[i].stage у объекта этапа",
            "Пока доступно копирование значений полей только основного объекта в поля только указанного объекта",
            "Указанные в качестве любого из имен полей 'сложные' имена будут проигнорированы"
          ],
          "filterFields": [{
            "stage": "queryID",
            "object": "ID"
          }],
          "valuesFields": [
            {
              "stage": "directorID",
              "object" : "directorID"
            }
          ]
        }
      ]
    },
    "stages_toBill": {
      "unique": {
        "queryID": "queryID"
      },
      "toNextUpdate": [
        {
          "object": "query",
          "comments" : [
            "filterFields - поля для формирования фильтра, valuesFields - определяемые значения",
            "Фильтр формируется по принципу объединения условий через AND",
            "Каждое условие - сравнение поля filterFields[i].object у объекта object со значением поля filterFields[i].stage у объекта этапа",
            "Пока доступно копирование значений полей только основного объекта в поля только указанного объекта",
            "Указанные в качестве любого из имен полей 'сложные' имена будут проигнорированы"
          ],
          "filterFields": [{
            "stage": "queryID",
            "object": "ID"
          }],
          "valuesFields": [
            {
              "stage": "directorID",
              "object" : "directorID"
            },
            {
              "stage": "controlID",
              "object" : "controlID"
            }
          ]
        }
      ]
    },
    "stages_finished": {
      "unique": {
        "queryID": "queryID"
      },
      "last": true
    },
    "stages_aborted": {
      "unique": {
        "queryID": "queryID"
      },
      "last": true
    }
  },
  "relations": [
    {
      "comment": "Переход с финансового контроля на вкладку согласования директора",
      "from": "stages_financeControl",
      "to": "stages_directorControl",
      "type": "post",
      "relation": {
        "fields": {
          "old.records.fields.queryID": "values.queryID",
          "old.records.fields.description": "values.description",
          "old.records.fields.commentary": "values.commentary",
          "old.records.fields.expenditureID": "values.expenditureID"
        },
        "behavior": {},
        "priority": "first",
        "condition": {
          "comparisons": {
            "hasGroup": {
              "left": {
                "type": "field",
                "value": "old.records.fields.expenditureID"
              },
              "right": {
                "type": "value",
                "value": ""
              },
              "sign": "unEqual"
            }
          },
          "tree": {
            "and": [
              "hasGroup"
            ]
          },
          "errorText": "Заполните статью расходов."
        }
      }
    },
    {
      "comment": "Переход с контроля директором на контроль УК",
      "from": "stages_directorControl",
      "to": "stages_controlCompanyControl",
      "type": "post",
      "relation": {
        "fields": {
          "old.records.fields.queryID": "values.queryID",
          "old.records.fields.description": "values.description",
          "old.records.fields.commentary": "values.commentary",
          "old.records.fields.expenditureID": "values.expenditureID"
        },
        "priority": "first",
        "condition": {
          "comparisons": {
            "outBudget": {
              "left": {
                "type": "field",
                "value": "old.records.fields.queryID.fields.inBudget"
              },
              "right": {
                "type": "value",
                "value": true
              },
              "sign": "unEqual"
            }
          },
          "tree": {
            "or": [
              "outBudget"
            ]
          }
        }
      }
    },
    {
      "comment": "Переход с контроля УК на оплату",
      "from": "stages_controlCompanyControl",
      "to": "stages_toBill",
      "type": "post",
      "relation": {
        "fields": {
          "old.records.fields.queryID": "values.queryID",
          "old.records.fields.description": "values.description",
          "old.records.fields.commentary": "values.commentary",
          "old.records.fields.expenditureID": "values.expenditureID"
        },
        "priority": "first"
      }
    },
    {
      "comment": "Переход с контроля директором на оплату",
      "from": "stages_directorControl",
      "to": "stages_toBill",
      "type": "post",
      "relation": {
        "fields": {
          "old.records.fields.queryID": "values.queryID",
          "old.records.fields.description": "values.description",
          "old.records.fields.commentary": "values.commentary",
          "old.records.fields.expenditureID": "values.expenditureID"
        },
        "priority": "first",
        "condition": {
          "comparisons": {
            "inBudget": {
              "left": {
                "type": "field",
                "value": "old.records.fields.queryID.fields.inBudget"
              },
              "right": {
                "type": "value",
                "value": true
              },
              "sign": "equal"
            }
          },
          "tree": {
            "or": [
              "inBudget"
            ]
          }
        },
        "behavior": {}
      }
    },
    {
      "comment": "Переход с оплаты на вкладку отработано",
      "from": "stages_toBill",
      "to": "stages_finished",
      "type": "post",
      "relation": {
        "fields": {
          "old.records.fields.queryID": "values.queryID",
          "old.records.fields.description": "values.description",
          "old.records.fields.commentary": "values.commentary",
          "old.records.fields.expenditureID": "values.expenditureID",
          "old.records.fields.directorID": "values.directorID",
          "old.records.fields.controlID": "values.controlID"
        },
        "priority": "first",
        "behavior": {},
        "condition": {
          "comparisons": {
            "hasDirector": {
              "left": {
                "type": "field",
                "value": "old.records.fields.directorID"
              },
              "right": {
                "type": "value",
                "value": ""
              },
              "sign": "unEqual"
            }
          },
          "tree": {
            "and": [
              "hasDirector"
            ]
          }
        }
      }
    }
  ],
  "input": {
    "stages_financeControl":{
      "comment":"Начальный этап - финансовый контроль.",
      "relation":{
        "fields":{
          "values.description":"values.description",
          "values.commentary":"values.commentary",
          "values.queryID":"values.queryID"
          },
          "behavior":{
            "pullOut": true
          }
      }
    }
  },
  "output": {
    "stages_finished": {
      "object": "stages",
      "method": "update",
      "relation": {
        "behavior": {},
        "fields": {
          "filter.all.posID": "filter.all.qid"
        },
        "direct": {
          "values": [
            {
              "workOut": true
            }
          ]
        }
      }
    }
  },
  "abort": "stages_aborted"
}