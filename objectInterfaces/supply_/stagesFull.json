{
  "name": "stages",
  "description": "Этапы",
  "common": "scheme",
  "fields": {
    "qid": {
      "type": "link",
      "link": "query_position",
      "required": true,
      "title": "Позиция"
    },
    "description": {
      "type": "string",
      "title": "Название"
    },
    "commentary": {
      "type": "string",
      "title": "Комментарий к заявке"
    },
    "tz": {
      "type": "string",
      "title": "Техзадание"
    },
    "productID": {
      "type": "link",
      "link": "product",
      "title": "Номенклатура"
    },
    "nomGroup": {
      "type": "link",
      "link": "product",
      "title": "Номенклатурная группа"
    },
    "stockID": {
      "type": "link",
      "link": "stock",
      "title": "Склад"
    },
    "organizationID": {
      "type": "link",
      "link": "organization",
      "title": "Организация"
    },
    "initiatorID": {
      "type": "link",
      "link": "initiator",
      "title": "Тот, кто создал заявку"
    },
    "quantity": {
      "type": "float",
      "title": "Количество"
    },
    "comment": {
      "type": "string",
      "title": "Комментарий"
    }
  },
  "stages": {
    "stages_tzPreparation": {
      "unique": {
        "qid": "positionID"
      }
    },
    "stages_nomControl": {
      "unique": {
        "qid": "positionID"
      },
      "toNextUpdate": [
        {
          "object": "query_position",
          "comments" : [
            "filterFields - поля для формирования фильтра, valuesFields - определяемые значения",
            "Фильтр формируется по принципу объединения условий через AND",
            "Каждое условие - сравнение поля filterFields[i].object у объекта object со значением поля filterFields[i].stage у объекта этапа",
            "Пока доступно копирование значений полей только основного объекта в поля только указанного объекта",
            "Указанные в качестве любого из имен полей 'сложные' имена будут проигнорированы"
          ],
          "filterFields": [{
            "stage": "positionID",
            "object": "ID"
          }],
          "valuesFields": [{
            "stage": "productID",
            "object" : "productID"
          }]
        }
      ],
      "auto": true
    },
    "stages_warehouseControl": {
      "unique": {
        "qid": "positionID"
      }
    },
    "stages_supSelection": {
      "unique": {
        "qid": "positionID"
      }
    },
    "stages_initialOffer": {
      "unique": {
        "qid": "positionID"
      }
    },
    "stages_procurementCommission": {
      "unique": {
        "qid": "positionID"
      }
    },
    "stages_billBinding": {
      "unique": {
        "qid": "positionID"
      },
      "toNextUpdate": [
        {
          "object": "query_position",
          "comment" : "filterFields - поля для формирования фильтра, valuesFields - определяемые значения",
          "filterFields": [{
            "stageField": "positionID",
            "objectField": "positionID"
          }],
          "valuesFields": [{
            "stage": "price",
            "object" : "price"
          }]
        }
      ]
    },
    "stages_acceptance": {
      "unique": {
        "qid": "positionID"
      },
      "last": true
    }
  },
  "relations": [
    {
      "comment": "Переход со складского контроля на подбор поставщиков, если нужной позиции нет в наличии",
      "from": "stages_warehouseControl",
      "to": "stages_supSelection",
      "type": "post",
      "relation": {
        "fields": {
          "old.records.fields.positionID": "values.positionID",
          "old.records.fields.productID": "values.productID",
          "old.records.fields.quantity": "values.quantity",
          "old.records.fields.description": "values.description",
          "old.records.fields.commentary": "values.commentary"
        },
        "behavior": {
          "pullOut": true
        },
        "condition": {
          "comparisons": {
            "notInStock":{
              "left": {
                "type": "field",
                "value": "old.records.fields.inStock"
              },
              "right": {
                "type": "value",
                "value": true
              },
              "sign": "unEqual"
            }
          },
          "tree": {"and": ["notInStock"]}
        }
      }
    },
    {
      "comment":"Переход с подготовки тз на номенклатурный контроль, если полное ТЗ заполнено",
      "from": "stages_tzPreparation",
      "to": "stages_nomControl",
      "type": "post",
      "relation":{
        "fields": {
          "old.records.fields.positionID": "values.positionID",
          "old.records.fields.description": "values.description",
          "old.records.fields.commentary": "values.commentary",
          "old.records.fields.tzComplete": "values.tzComplete",
          "old.records.fields.nomGroup": "values.nomGroup",
          "old.records.fields.quantity": "values.quantity"
        },
        "behavior":{
          "pullOut": "true"
        },
        "condition": {
          "comparisons": {
            "hasTz": {
              "left": {
                "type": "field",
                "value": "old.records.fields.tzComplete"
              },
              "right": {
                "type": "value",
                "value": ""
              },
              "sign": "unEqual"
            }
          },
          "tree": {"and": ["hasTz"]}
        }
      }
    },
    {
      "comment": "Переход со номенклатурного контроля на подбор поставщиков, если номенклатура заполнена",
      "from": "stages_nomControl",
      "to": "stages_warehouseControl",
      "type": "post",
      "relation": {
        "fields": {
          "old.records.fields.positionID": "values.positionID",
          "old.records.fields.description": "values.description",
          "old.records.fields.commentary": "values.commentary",
          "old.records.fields.nomGroup": "values.nomGroup",
          "old.records.fields.productID": "values.productID",
          "old.records.fields.quantity": "values.quantity"
        },
        "behavior": {},
        "priority": "first",
        "condition": {
          "comparisons": {
            "hasNom": {
              "left": {
                "type": "field",
                "value": "old.records.fields.productID"
              },
              "right": {
                "type": "value",
                "value": ""
              },
              "sign": "unEqual"
            }
          },
          "tree": {
            "and": [
              "hasNom"
            ]
          }
        }
      }
    },
    {
      "comment": "Переход с подбора поставщиков на первичное предложение если поставщиков указано как минимум 1",
      "from": "stages_supSelection",
      "to": "stages_initialOffer",
      "type": "uber",
      "relation": {
        "fields": {
          "old.records.fields.positionID": "values.positionID",
          "old.records.fields.commentary": "values.commentary",
          "old.records.fields.description": "values.description",
          "old.records.fields.productID": "values.productID",
          "old.records.fields.quantity": "values.quantity",
          "old.records.refs.stages_supSelection_suppliers.fields.description": "values.refs.stages_initialOffer_offers.description",
          "old.records.refs.stages_supSelection_suppliers.fields.commentary": "values.refs.stages_initialOffer_offers.commentary",
          "old.records.refs.stages_supSelection_suppliers.fields.supplier": "values.refs.stages_initialOffer_offers.supplier"
        },
        "priority": "first",
        "behavior": {
          "checkMinQuantity": {
            "stages_offerAnalysis_offers": 1
          }
        }
      }
    },
    {
      "comment": "Переход с закупочной комиссии на привязку счетов, если за поставщика проголосовали",
      "from": "stages_procurementCommission",
      "to": "stages_billBinding",
      "type": "post",
      "relation": {
        "fields": {
          "old.records.fields.positionID": "values.positionID",
          "old.records.fields.commentary": "values.commentary",
          "old.records.fields.productID": "values.productID",
          "old.records.fields.quantity": "values.quantity",
          "old.records.refs.stages_procurementCommission_votes.fields.supplier": "values.supplier",
          "old.records.refs.stages_procurementCommission_votes.fields.price": "values.price",
          "old.records.refs.stages_procurementCommission_votes.fields.deliveryTime": "values.deliveryTime"
        },
        "priority": "first",
        "behavior": {},
        "condition": {
          "comparisons": {
            "hasVote": {
              "left": {
                "type": "field",
                "value": "old.records.refs.stages_procurementCommission_votes.fields.vote"
              },
              "right": {
                "type": "value",
                "value": true
              },
              "sign": "equal"
            }
          },
          "tree": {
            "and": [
              "hasVote"
            ]
          }
        }
      }
    },
    {
      "comment": "Переход с привязки счетов на приёмку товара, если документ со счётом привязан",
      "from": "stages_billBinding",
      "to": "stages_acceptance",
      "type": "post",
      "relation": {
        "fields": {
          "old.records.fields.positionID": "values.positionID",
          "old.records.fields.commentary": "values.commentary",
          "old.records.fields.productID": "values.productID",
          "old.records.fields.supplier": "values.supplier",
          "old.records.fields.price": "values.price",
          "old.records.fields.deliveryTime": "values.deliveryTime",
          "old.records.fields.bill": "values.bill",
          "old.records.fields.quantity": "values.quantity"
        },
        "condition": {
          "comparisons": {
            "hasBill": {
              "left": {
                "type": "field",
                "value": "old.records.fields.bill"
              },
              "right": {
                "type": "value",
                "value": ""
              },
              "sign": "unEqual"
            }
          },
          "tree": {
            "and": [
              "hasBill"
            ]
          }
        }
      }
    }
  ],
  "input": {
    "stages_warehouseControl":{
      "comment":"Начальный этап - складской контроль; сюда попадают позиции, у которых указана номенклатура.",
      "relation":{
        "fields":{
          "values.description":"values.description",
          "values.commentary":"values.commentary",
          "values.qid":"values.positionID",
          "values.nomGroup": "values.nomGroup",
          "values.productID":"values.productID",
          "values.quantity":"values.quantity"
        },
        "behavior":{
          "pullOut": true
        },
        "condition":{
          "comparisons":{
            "hasNom":{
              "left":{
                "type": "field",
                "value": "values.productID"
              },
              "right":{
                "type": "value",
                "value": ""
              },
              "sign":"unEqual"
            }
          },
          "tree":{"and": ["hasNom"]}
        }
      }
    },
    "stages_tzPreparation" :{
      "comment":"Начальный этап подготовки ТЗ - сюда попадают позиции без указания номенклатуры; должна быть номенклатурная группа и ТЗ",
      "relation":{
        "fields":{
          "values.description":"values.description",
          "values.commentary":"values.commentary",
          "values.qid": "values.positionID",
          "values.tz": "values.tz",
          "values.nomGroup": "values.nomGroup",
          "values.quantity": "values.quantity"
        },
        "behavior":{
          "pullOut": true
        },
        "condition":{
          "comparisons": {
            "hasTz":{
              "left": {
                "type": "field",
                "value": "values.tz"
              },
              "right": {
                "type": "value",
                "value": ""
              },
              "sign": "unEqual"
            },
            "hasGroup": {
              "left": {
                "type": "field",
                "value": "values.nomGroup"
              },
              "right": {
                "type": "value",
                "value": ""
              },
              "sign": "unEqual"
            },
            "noNom":{
              "left":{
                "type": "field",
                "value": "values.productID"
              },
              "right":{
                "type": "value",
                "value": ""
              },
              "sign":"equal"
            }
          },
          "tree": {"and": ["hasTz", "hasGroup", "noNom"]}
        }
      }
    }
  },
  "output": {
    "stages_acceptance": {
      "object": "stages",
      "method": "update",
      "relation": {
        "behavior": {},
        "fields": {
          "filter.all.posID": "filter.all.qid"
        },
        "direct": {
          "values": [
            {
              "workOut": true
            }
          ]
        }
      }
    }
  }
}